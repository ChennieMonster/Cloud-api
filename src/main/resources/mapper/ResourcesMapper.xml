<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cloud.api.mapper.ResourcesMapper">
  <resultMap id="ResourcesMap" type="com.cloud.api.dto.ResourcesDTO">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="cpu_total" jdbcType="DECIMAL" property="cpuTotal" />
    <result column="cpu_usage" jdbcType="DECIMAL" property="cpuUsage" />
    <result column="memory_total" jdbcType="DECIMAL" property="memoryTotal" />
    <result column="memory_usage" jdbcType="DECIMAL" property="memoryUsage" />
    <result column="pod_total" jdbcType="DECIMAL" property="podTotal" />
    <result column="pod_usage" jdbcType="DECIMAL" property="podUsage" />
    <result column="display_name" jdbcType="VARCHAR" property="displayName" />
    <result column="description" jdbcType="VARCHAR" property="description" />
  </resultMap>
  
  <select id="selectHostResourcesByRegionId" parameterType="string" resultMap="ResourcesMap">
	SELECT
		sum( t1.cpu ) AS cpu_total,
		sum( round( ( t1.cpu * t1.cpu_util ) / 100, 2 ) ) AS cpu_usage,
		sum( round( t1.memory / 1024 / 1024 ) ) AS memory_total,
		sum( round( t1.memory_usage / 1024 / 1024 ) ) AS memory_usage 
	FROM
		monitor_physical_nodes t1,
		node t2 
	WHERE
		t2.region_id = #{regionId} 
		AND t1.node_id = t2.uuid  	
  </select>
  
  <select id="selectProjectAppTotal" parameterType="java.util.Map" resultType="java.util.Map">
	SELECT
		count( 0 ) AS appTotal,
		t2.NAME as name,
		t2.display_name as displayName,
		t2.description as description
	FROM
		application t1,
		project t2 
	WHERE
			t1.is_registry = 0 
		AND t1.project = t2.uuid 
		AND t2.region_id=#{regionId}
	GROUP BY
		t1.project 
	ORDER BY
		appTotal DESC 
	 <if test="limit != null">
        limit #{limit}
      </if>
  </select>
  
  <select id="selectAllAppTotalByRegionId" parameterType="string" resultType="java.lang.Integer">
  	select count(0) as regionAppTotal from project t1,application t2 where t1.region_id=#{regionId} and t2.project=t1.uuid 
  </select>
  
  <select id="selectProjectResourceByRegionId" parameterType="java.util.Map" resultMap="ResourcesMap">
  	SELECT
		t1.cpu_total,
		t1.cpu_used AS cpu_usage,
		t1.memory_total,
		t1.memory_used AS memory_usage,
		t1.pods_total AS pod_total,
		t1.pods_used AS pod_usage,
		t2.name,
		t2.display_name,
		t2.description 
	FROM
		quota_resource t1,
		project t2
	WHERE
			t1.region_id = #{regionId}
		and t1.project = t2.uuid
	ORDER BY
		memory_usage DESC 
	 <if test="limit != null">
        limit #{limit}
     </if>
  </select>
  
  <select id="selectProjectResourceDetail" parameterType="java.util.Map" resultMap="ResourcesMap">
  	SELECT
		cpu_total,
		cpu_used AS cpu_usage,
		memory_total,
		memory_used AS memory_usage,
		pods_total AS pod_total,
		pods_used AS pod_usage 
	FROM
		quota_resource 
	WHERE
		region_id = #{regionId}
		AND project = #{project}
  </select>
  
  <select id="selectProjectAppStatus" parameterType="string" resultType="java.lang.Integer">
  	SELECT
		count( uuid ) AS count
	FROM
		application 
	WHERE
			project = #{project} 
		and status=#{status}
  </select>
  
  <select id="selectRegionAppStatus" parameterType="java.util.Map" resultType="java.lang.Integer">
  	SELECT
		count( uuid ) AS count
	FROM
		application 
	WHERE
			project IN ( SELECT uuid FROM project WHERE region_id = #{regionId} ) 
		and status=#{status}
  </select>
  
  <select id="selectAppCountDailyCreate" parameterType="string" resultType="java.lang.Integer">
  	SELECT
		count(0) 
	FROM
		application 
	WHERE
		to_days( created_time ) = to_days( now( ) )
  </select>
</mapper>